---
title: "Lake script(run)ã§ãƒã‚¤ãƒŠãƒªã‚’å®Ÿè¡Œã™ã‚‹"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["lean", "lean4", "lake"]
published: true
---

[Lake](https://github.com/leanprover/lean4/tree/master/src/lake)ã§`cargo run`ã¿ãŸã„ãªã“ã¨ã‚’ã™ã‚‹æ–¹æ³•ã‚’ãƒ¡ãƒ¢ã‚Šã¾ã™ã€‚
è©¦è¡ŒéŒ¯èª¤éç¨‹æ··ã–ã£ã¦ã¾ã™ã€‚

# ç’°å¢ƒ
```sh
$ lean --version
Lean (version 4.12.0, x86_64-unknown-linux-gnu, commit dc2533473114, Release)
```
`lakefile`ã¯leanã§æ›¸ãã¾ã™(å‹ä»˜ã‘ã‚„è£œå®ŒãŒã•ã‚Œã‚‹ã®ã§)(Tomlã§ã¯ã‚ã‚Šã¾ã›ã‚“)ã€‚

# æœ¬é¡Œ

## `lake run`ã¨ã¯
`lake run`ã¯ãƒ˜ãƒ«ãƒ—ã®é€šã‚Šã€`lake script run`ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§ã™ã€‚
`lake script`ã§ã¯scriptã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
scriptã¯`lakefile`ã®`script`å®£è¨€ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™([README](https://github.com/leanprover/lean4/tree/master/src/lake#writing-and-running-scripts))ã€‚

ä»¥ä¸‹ã€å…¬å¼ã«è¼‰ã£ã¦ã‚‹ä¾‹ã§ã™
```lean
import Lake
open Lake DSL

package scripts

/--
Display a greeting

USAGE:
  lake run greet [name]

Greet the entity with the given name. Otherwise, greet the whole world.
-/
script greet (args) do
  if h : 0 < args.length then
    IO.println s!"Hello, {args[0]'h}!"
  else
    IO.println "Hello, world!"
  return 0
```

`main`ã¿ãŸã„ãªé–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ã‚ã¨ã“ã“ã®doc comment(?)ã¯ã€`lake script doc`ã§èª­ã‚ã¾ã™ã€‚

## å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰å‘¼ã³å‡ºã—
æ¬¡ã«å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã‚’å‘¼ã¶æ–¹æ³•ã‚’æ¢ã—ã¾ã™ã€‚
leanprover-communityã®github.ioã®API documentã§é©å½“ã«`Process`ã¨ã‹ã§èª¿ã¹ã‚‹ã¨ã€[`IO.Process.SpawnArgs`](https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.Process.SpawnArgs)ã¨ã‹ã€[`IO.Process.spawn`](https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.Process.spawn)ã¨ã‹ãŒå‡ºã¦ãã¾ã™ã€‚
å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰å‘¼ã³å‡ºã—ã‚’ä»–ã®è¨€èªã§ã‚„ã£ãŸã“ã¨ã‚ã‚‹äººãªã‚‰ãªã‚“ã¨ãªãç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯æ¨™æº–å‡ºåŠ›ã¨æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’ä»–ã®streamã¿ãŸã„ãªã‚‚ã®ã«ã—ã¦ãã‚Œã‚’ã¾ãŸãã®ã¾ã¾æ¨™æº–å‡ºåŠ›/æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«æµã—ã¦ã¾ã™ã€‚([`IO.Process.Stdio.toHandleType`](https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.Process.Stdio.toHandleType)ã‚’ä½¿ã„ã¾ã—ãŸã€‚)
```lean: processspawn.lean
let proc â† IO.Process.spawn
  âŸ¨{stdin := .inherit, stdout := .piped, stderr := .piped},
    ".lake/build/bin/foo", args.toArray, none, #[], false âŸ©
IO.print (â† proc.stdout.readToEnd)
IO.eprintln (â† IO.FS.Handle.readToEnd proc.stderr)
let ret â† proc.wait
```

## å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ã§å–å¾—ã™ã‚‹
ã“ã‚Œã§ä¸€å¿œ`lake run foo`ã¿ãŸã„ãªã®ã§ãƒã‚¤ãƒŠãƒªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™(ãƒ“ãƒ«ãƒ‰ã¯ã§ãã¾ã›ã‚“)ã€‚
ã“ã‚Œã¯ã‚«ãƒƒã‚³æ‚ªã„ã—ã€ä½•ã‚ˆã‚ŠWindowsã§ã¯`.exe`ãŒã¤ã„ã¦ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤‰ã‚ã‚‹ã®ã§ã“ã®æ–¹æ³•ã¯ä½¿ãˆã¾ã›ã‚“ã€‚

ãã“ã§ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å®šç¾©çš„ãªã‚‚ã®ã‹ã‚‰å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚
ãƒã‚¤ãƒŠãƒªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸(ã“ã“ã§ã¯ä»®ã«`foo`ã¨å‘¼ã³ã¾ã™)ã®å‹ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`LeanExeConfig`ã¨å‡ºã¦ãã¾ã™ã€‚
å…ˆã»ã©ã¨åŒã˜æ„Ÿã˜ã§APIã‚’æ¤œç´¢ã™ã‚‹ã¨ãã‚Œã£ã½ã„ã‚‚ã®[`LeanExeConfig.get`](https://leanprover-community.github.io/mathlib4_docs/Lake/Build/Targets.html#Lake.LeanExeConfig.get)ãŒãƒ’ãƒƒãƒˆã—ã¾ã—ãŸã€‚
ãã“ã‹ã‚‰è‰²ã€…ã™ã‚‹ã¨å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒå–å¾—ã§ãã¾ã™ã€‚

# ã¾ã¨ã‚
æœ€çµ‚å½¢ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```lean lakefile.lean
/--
Test binary target
-/
script test (args) do
  let exe := (â† foo.get).file
  IO.println s!"exe: {exe}"
  IO.println s!"args: {args}"
  let proc â† IO.Process.spawn
    âŸ¨{stdin := .inherit, stdout := .piped, stderr := .piped},
      exe.toString, args.toArray, none, #[], false âŸ©
  IO.print (â† proc.stdout.readToEnd)
  IO.eprintln (â† IO.FS.Handle.readToEnd proc.stderr)
  let ret â† proc.wait
  IO.println s!"returned: {ret}"
  pure ret
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§å‹ä»˜ã‘ã•ã‚ŒãŸã‚Šè£œå®ŒãŒåŠ¹ãä½“é¨“å¿«é©ã§ã™ã­[^1]ã€‚

[^1]: Zennã§ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯åŠ¹ã‹ãªã„ã‘ã©

